{% if title %}
<aside class="ms-aside-caption">
  <p><strong>{{ title }}</strong>
    {% if description %}
    <br>{{ description | safe }}
    {% endif %}
  </p>
</aside>
{% endif %}

{# Reserved keys that should not be treated as marginals #}
{% set reserved = ["title", "caption", "description", "file_url", "file_label", "collapse", "html_description", "data", "link"] %}

{# Legacy link handling for backward compatibility #}
{% if link %}
{% for l in link %}
<aside class="ms-aside-link">
  {% if l.startswith('http') and not l.startswith('[') %}
    <p><a href="{{ l }}">{{ l }}</a></p>
  {% else %}
    {{ l | markdown | safe }}
  {% endif %}
</aside>
{% endfor %}
{% endif %}

{# Iterate over all top-level keys and render as marginals #}
{% if data %}
{% for slug, value in data.items() %}
  {% if slug not in reserved %}
    {% if value is string %}
      <aside class="ms-aside-{{ slug }}">
        {{ value | markdown | safe }}
      </aside>
    {% else %}
      {% for element in value %}
        <aside class="ms-aside-{{ slug }}">
          {{ element | markdown | safe }}
        </aside>
      {% endfor %}
    {% endif %}
  {% endif %}
{% endfor %}
{% endif %}

{# Legacy support for file_url and file_label #}
{% if file_url %}
<aside class="ms-aside-file">
  <p><a href="{{ file_url }}">{{ file_label or file_url }}</a></p>
</aside>
{% endif %}
